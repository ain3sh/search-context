name: Sync Context Search Stores

on:
  schedule:
    - cron: '0 2 * * *'    # 2 AM UTC daily
  workflow_dispatch:
  repository_dispatch:
    types: [docs-updated]

permissions:
  contents: write

concurrency:
  group: sync-context-stores
  cancel-in-progress: false

jobs:
  sync-stores:
    runs-on: ubuntu-latest

    steps:
      # Repo containing the workflow and the state file we commit
      - name: Checkout search-context repository (for workflow & state file)
        uses: actions/checkout@v4
        with:
          repository: ain3sh/search-context
          path: search-context
          fetch-depth: 0
          persist-credentials: true
          ref: main

      # Repo whose contents we index
      - name: Checkout ain3sh/docs repository (for indexing)
        uses: actions/checkout@v4
        with:
          repository: ain3sh/docs
          path: docs
          fetch-depth: 0  # Need full history for change detection
          persist-credentials: true
          ref: main

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          set -euo pipefail
          pip install google-genai python-dotenv

      - name: Get last sync timestamp (from state file in search-context)
        id: last-sync
        shell: bash
        run: |
          set -euo pipefail
          STATE_FILE="search-context/.context-sync/last-docs-commit.txt"
          if [ -f "$STATE_FILE" ]; then
            LAST_SYNC_DOCS_COMMIT=$(cat "$STATE_FILE")
            echo "Found previous sync marker: $LAST_SYNC_DOCS_COMMIT"
            echo "last_docs_commit=$LAST_SYNC_DOCS_COMMIT" >> "$GITHUB_OUTPUT"
          else
            echo "No previous sync marker file found - full sync will run."
            echo "last_docs_commit=" >> "$GITHUB_OUTPUT"
          fi

      - name: Detect changed directories since last sync
        id: changed-dirs
        env:
          DOCS_PATH: docs
          MAX_DEPTH: 2
          LAST_SYNC_DOCS_COMMIT: ${{ steps.last-sync.outputs.last_docs_commit }}
        shell: bash
        run: |
          set -euo pipefail
          # Runs from workspace root; script uses DOCS_PATH, MAX_DEPTH, LAST_SYNC_DOCS_COMMIT
          python search-context/.github/scripts/detect_changed_dirs.py

      - name: Sync FileSearchStores (with retries)
        id: sync
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          DOCS_PATH: docs
          CHANGED_DIRS: ${{ steps.changed-dirs.outputs.changed_dirs }}
        shell: bash
        run: |
          set -euo pipefail
          attempts=0
          max_attempts=3
          backoff=10
          until python search-context/.github/scripts/sync_stores.py; do
            code=$?
            attempts=$((attempts+1))
            if [ $attempts -ge $max_attempts ]; then
              echo "Sync failed after ${attempts} attempts (last exit $code)."
              exit $code
            fi
            echo "Sync attempt ${attempts} failed (exit $code). Retrying in ${backoff}s..."
            sleep $backoff
            backoff=$((backoff*2))
          done

      - name: Record last synced docs commit (state file in search-context)
        if: steps.sync.outcome == 'success'
        shell: bash
        run: |
          set -euo pipefail

          DOCS_SHA=$(cd docs && git rev-parse HEAD)
          mkdir -p search-context/.context-sync
          echo "$DOCS_SHA" > search-context/.context-sync/last-docs-commit.txt

          cd search-context

          # Make sure we're on main and up to date
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -B main
          git pull --rebase origin main

          # Stage first so untracked files are considered by the diff
          git add .context-sync/last-docs-commit.txt

          # Commit only if there is a staged change
          if git diff --cached --quiet; then
            echo "State file unchanged; no commit needed."
          else
            git commit -m "chore: update last synced docs commit to $DOCS_SHA"
            git push origin HEAD:main
            echo "Recorded and pushed docs commit $DOCS_SHA"
          fi

      - name: Report sync status
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          if [ -f /tmp/sync_summary.txt ]; then
            # shellcheck disable=SC1091
            source /tmp/sync_summary.txt
            echo "üìä Sync Summary:"
            echo "   Directories synced: ${synced_count:-0}"
            echo "   Files uploaded: ${files_uploaded:-0}"
            echo "   Files skipped: ${files_skipped:-0}"
            echo "   Files failed: ${files_failed:-0}"
            # Print a literal $ followed by the expanded value
            echo "   Total cost: \$${total_cost:-0.0000}"
            echo "   State file path: search-context/.context-sync/last-docs-commit.txt"
            echo "   Next scheduled sync: Tomorrow at 2 AM UTC"
            if [ "${files_failed:-0}" -gt 0 ]; then
              echo ""
              echo "‚ö†Ô∏è  Warning: ${files_failed} files failed to upload"
            fi
          else
            echo "‚ö†Ô∏è Sync did not complete successfully"
          fi
